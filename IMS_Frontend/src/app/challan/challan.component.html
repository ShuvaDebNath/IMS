<div class="challan-card">
  <form [formGroup]="searchForm" class="search-form">
    <fieldset class="search-fieldset">
      <legend>Search</legend>
      <p-divider />
      <div class="row">
        <div class="col-md-2 form-group">
          <label>Challan Number</label>
          <input type="text" formControlName="challanNo" class="form-control" placeholder="Challan Number" />
        </div>

        <div class="col-md-2 form-group">
          <label>PI No</label>
          <input type="text" formControlName="piNo" class="form-control" placeholder="PI No" />
        </div>

        <div class="col-md-2 form-group">
          <label>From Date</label>
          <input type="date" formControlName="fromDate" class="form-control" />
        </div>

        <div class="col-md-2 form-group">
          <label>To Date</label>
          <input type="date" formControlName="toDate" class="form-control" />
        </div>

        <div class="col-md-2 form-group d-flex justify-content-end align-items-end">
          <button type="button" class="btn theme-btn" (click)="onSearch()">Search</button>
          <button type="button" class="btn btn-secondary" style="margin-left:8px;color:#fff;" (click)="clear()">Clear</button>
        </div>
      </div>
    </fieldset>
  </form>

  <div *ngIf="showTable" class="table-panel">
    <p-table [value]="tableData" responsiveLayout="scroll" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20]">
      <ng-template pTemplate="header">
        <tr>
          <th style="text-align:center">Date</th>
          <th style="text-align:center">Client Name</th>
          <th style="text-align:center">PI Number</th>
          <th style="text-align:center">Article</th>
          <th style="text-align:center">Color</th>
          <th style="text-align:center">Ordered Qty</th>
          <th style="text-align:center">Delivered Qty</th>
          <th style="text-align:center">Challan No</th>
          <th style="text-align:center">Generated By</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row let-i="rowIndex">
        <tr>
          <td style="text-align:center">{{ row.Date}}</td>
          <td>{{ row.ClientName }}</td>
          <td style="text-align:center">{{ row.PINo }}</td>
          <td style="text-align:center">{{ row.Article  }}</td>
          <td style="text-align:center">{{ row.Color }}</td>
          <td style="text-align:center">{{ row.Quantity }}</td>
          <td style="text-align:center">{{ row.Delivered }}</td>
          <td style="text-align:center">
            <a href="javascript:void(0)" (click)="openChallanDetails(row.Chalan_No)">
              {{ row.Chalan_No }}
            </a>
          </td>
          <td style="text-align:center">{{ row.UserName }}</td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9">No data found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Challan Details Dialog -->
<p-dialog header="Delivery Challan" [(visible)]="isChallanDetailsVisible" [modal]="true" [closable]="true" [style]="{ width: '80vw' }" [contentStyle]="{'max-height':'70vh','overflow':'auto'}" (onHide)="isChallanDetailsVisible=false">
  <div *ngIf="challanDetails">
    <div class="delivery-header theme-bg text-white" style="padding:18px;margin-bottom:12px;border-radius:4px;text-align:center;">
      <h3 style="margin:0">Delivery Challan</h3>
    </div>

    <div class="row mb-2">
      <div class="col-md-8">
        <div><strong>PI No :</strong> {{ challanDetails.master?.PINo }}</div>
        <div><strong>Consignee Name :</strong> {{ challanDetails.master?.Company_Name }}</div>
        <div><strong>Delivery Address :</strong> {{ challanDetails.master?.Delivery_Address }}</div>
        <div><strong>Contact Person :</strong> {{ challanDetails.master?.Contact_Person }}</div>
        <div><strong>Buyer Name :</strong> {{ challanDetails.master?.Buyer_Name }}</div>
        <div><strong>Style :</strong> {{ challanDetails.master?.Style }}</div>
      </div>
      <div class="col-md-4 text-right">
        <div><strong>Challan No :</strong> {{ challanDetails.master?.Chalan_No }}</div>
        <div style="margin-top:6px;">
          <strong>Date :</strong>
          <ng-container *ngIf="!isEditingDate">
            <span> {{ challanDetails.master?.Date }}</span>
            <button *ngIf="updatePermissions" type="button" class="btn btn-sm theme-btn" style="margin-left:8px;padding:4px 8px;" (click)="toggleEditDate()">Change</button>
          </ng-container>
          <ng-container *ngIf="isEditingDate">
            <input type="date" [(ngModel)]="editDate" class="form-control d-inline-block" style="width:140px;display:inline-block;margin-left:8px;" />
            <button type="button" class="btn btn-sm theme-btn" style="margin-left:8px;padding:4px 8px;" (click)="saveDateChange()">Save</button>
            <button type="button" class="btn btn-sm btn-secondary" style="margin-left:8px;color:#fff;padding:4px 8px;" (click)="toggleEditDate()">Cancel</button>
          </ng-container>
        </div>
        <div><strong>Performed By :</strong> {{ challanDetails.master?.UserName }}</div>
      </div>
    </div>

    <p-table [value]="challanDetails.details" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>Item</th>
          <th>Article</th>
          <th>Color</th>
          <th>Width</th>
          <th>Packaging</th>
          <th>Roll/Box/Pcs</th>
          <th>Quantity</th>
          <th>Unit</th>
          <th>Remark</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-row>
        <tr>
          <td>{{ row.Description}}</td>
          <td>{{ row.Article }}</td>
          <td>{{ row.Color }}</td>
          <td>{{ row.Width }}</td>
          <td>{{ row.Packaging }}</td>
          <td style="text-align:center">{{ row.Roll }}</td>
          <td style="text-align:center">{{ row.Delivered }}</td>
          <td>{{ row.Unit }}</td>
          <td>{{ row.Remark }}</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="footer">
        <tr class="font-weight-bold">
          <td colspan="5" style="text-align:right">Totals</td>
          <td style="text-align:center">{{ challanTotalsRolls | number:'1.2-2' }}</td>
          <td style="text-align:right">{{ challanTotalsDelivered | number:'1.2-2' }}</td>
          <td></td>
          <td></td>
        </tr>
      </ng-template>
    </p-table>
    <!-- action buttons aligned bottom-left like design -->
    <div class="mt-3">
          <div class="d-flex">
        <div class="mr-auto">
          <button *ngIf="deletePermissions" class="btn theme-btn-delete" (click)="deleteChallan()"><i class="fas fa-trash"></i>&nbsp;Delete</button>
          <button *ngIf="updatePermissions" class="btn theme-btn-add" style="margin-left:8px;" (click)="openEditChallanModal(challanDetails.master?.Chalan_No)"><i class="fas fa-edit"></i>&nbsp;Edit Challan No</button>
          <button *ngIf="printPermissions" class="btn theme-btn" style="margin-left:8px;"  (click)="printChallan(challanDetails.master?.Chalan_No)"><i class="fas fa-print"></i>&nbsp;Print</button>
        </div>
      </div>
    </div>
  </div>
</p-dialog>

<!-- Edit Challan No Dialog -->
<p-dialog header="Edit Challan No" [(visible)]="isEditChallanVisible" [modal]="true" [closable]="true" [style]="{ width: '30vw' }" (onHide)="isEditChallanVisible=false">
  <div class="p-3">
    <div class="form-group">
      <label>Old Challan No</label>
      <input type="text" class="form-control" [value]="editOldChallan" readonly />
    </div>
    <div class="form-group">
      <label>New Challan No</label>
      <input type="text" class="form-control" [(ngModel)]="editNewChallan" />
    </div>
    <div class="text-right mt-2">
      <button class="btn theme-btn" (click)="saveEditChallan()">Save</button>
      <button class="btn btn-secondary" style="margin-left:8px;color:#fff;" (click)="isEditChallanVisible=false">Cancel</button>
    </div>
  </div>
</p-dialog>
